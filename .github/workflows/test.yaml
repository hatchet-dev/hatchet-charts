name: test

on:
  pull_request:
    branches:
      - main

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Set up Helm
        uses: azure/setup-helm@v4

      - name: Set up kind
        uses: helm/kind-action@v1.12.0

      - name: Add Helm repositories
        run: |
          helm repo add bitnami https://charts.bitnami.com/bitnami
          helm repo update

      - name: Lint all charts
        run: |
          for chart in charts/*/; do
            echo "Linting $chart"
            helm lint "$chart"
          done

      - name: Install and test hatchet-api chart
        run: |
          helm install hatchet-api-test charts/hatchet-api \
            --set-json 'deploymentEnvFrom=[]' \
            --set setupJob.enabled=false \
            --set migrationJob.enabled=false \
            --set seedJob.enabled=false \
            --set quickstartJob.enabled=false \
            --set workerTokenJob.enabled=false \
            --set ingress.enabled=false \
            --timeout=1m

          kubectl get pods -l app.kubernetes.io/name=hatchet-api
          helm test hatchet-api-test || true
          helm uninstall hatchet-api-test

      - name: Install and test hatchet-frontend chart
        run: |
          helm install hatchet-frontend-test charts/hatchet-frontend \
            --set ingress.enabled=false \
            --timeout=1m

          kubectl get pods -l app.kubernetes.io/name=hatchet-frontend
          helm test hatchet-frontend-test || true
          helm uninstall hatchet-frontend-test

      - name: Install and test hatchet-stack chart
        run: |
          helm dependency build charts/hatchet-stack

          helm install hatchet-stack-test charts/hatchet-stack \
            --set postgres.enabled=false \
            --set rabbitmq.enabled=false \
            --timeout=1m

          kubectl get pods
          helm test hatchet-stack-test || true

          helm uninstall hatchet-stack-test || true
      - name: Template test all charts
        run: |
          helm dependency build charts/hatchet-stack
          helm dependency build charts/hatchet-api
          helm dependency build charts/hatchet-frontend
          helm dependency build charts/hatchet-ha

          for chart in charts/*/; do
            chart_name=$(basename "$chart")
            echo "Testing template rendering for $chart_name"

            case "$chart_name" in
              "hatchet-stack")
                helm template test-release "$chart" > /dev/null
                ;;
              "hatchet-api"|"hatchet-frontend")
                helm template test-release "$chart" > /dev/null
                ;;
              "hatchet-ha")
                helm template test-release "$chart" > /dev/null
                ;;
            esac

            echo "âœ“ Template rendering successful for $chart_name"
          done

  loadtest-stack:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Set up Helm
        uses: azure/setup-helm@v4

      - name: Set up kind
        uses: helm/kind-action@v1.12.0

      - name: Add Helm repositories
        run: |
          helm repo add bitnami https://charts.bitnami.com/bitnami
          helm repo update

      - name: Run load test
        run: |
          ./hack/kind-stack-loadtest.sh
        env:
          VERSION: v0.71.0
          
  loadtest-ha:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Set up Helm
        uses: azure/setup-helm@v4

      - name: Set up kind
        uses: helm/kind-action@v1.12.0
        with:
          config: |
            kind: Cluster
            apiVersion: kind.x-k8s.io/v1alpha4
            nodes:
            - role: control-plane
            - role: worker
            - role: worker

      - name: Add Helm repositories
        run: |
          helm repo add bitnami https://charts.bitnami.com/bitnami
          helm repo update

      - name: Run load test
        run: |
          ./hack/kind-ha-loadtest.sh

  security-scan:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Run Checkov action
        uses: bridgecrewio/checkov-action@v12
        with:
          directory: charts/
          framework: kubernetes
          output_format: sarif
          output_file_path: reports/results.sarif
          skip_check: CKV_K8S_40,CKV_K8S_43

      - name: Upload SARIF file
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: reports/results.sarif