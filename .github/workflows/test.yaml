name: Test Charts

on:
  pull_request:
    branches:
      - main
  push:
    branches:
      - main

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Set up Helm
        uses: azure/setup-helm@v4

      - name: Set up kind
        uses: helm/kind-action@v1.12.0

      - name: Add Helm repositories
        run: |
          helm repo add bitnami https://charts.bitnami.com/bitnami
          helm repo update

      - name: Lint all charts
        run: |
          for chart in charts/*/; do
            echo "Linting $chart"
            helm lint "$chart"
          done

      - name: Install and test hatchet-api chart
        run: |
          helm install hatchet-api-test charts/hatchet-api \
            --wait --timeout=5m

          kubectl get pods -l app.kubernetes.io/name=hatchet-api
          helm test hatchet-api-test || true
          helm uninstall hatchet-api-test

      - name: Install and test hatchet-frontend chart
        run: |
          helm install hatchet-frontend-test charts/hatchet-frontend \
            --wait --timeout=5m

          kubectl get pods -l app.kubernetes.io/name=hatchet-frontend
          helm test hatchet-frontend-test || true
          helm uninstall hatchet-frontend-test

      - name: Install and test hatchet-stack chart
        run: |
          helm install hatchet-stack-test charts/hatchet-stack \
            --wait --timeout=5m

          kubectl get pods
          helm test hatchet-stack-test || true
          helm uninstall hatchet-stack-test

      - name: Template test all charts
        run: |
          for chart in charts/*/; do
            chart_name=$(basename "$chart")
            echo "Testing template rendering for $chart_name"

            case "$chart_name" in
              "hatchet-stack")
                helm template test-release "$chart" > /dev/null
                ;;
              "hatchet-api"|"hatchet-frontend")
                helm template test-release "$chart" > /dev/null
                ;;
              "hatchet-ha")
                helm template test-release "$chart" > /dev/null
                ;;
            esac

            echo "âœ“ Template rendering successful for $chart_name"
          done

  security-scan:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Run Checkov action
        uses: bridgecrewio/checkov-action@v12
        with:
          directory: charts/
          framework: kubernetes
          output_format: sarif
          output_file_path: reports/results.sarif
          skip_check: CKV_K8S_40,CKV_K8S_43

      - name: Upload SARIF file
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: reports/results.sarif